using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class Exploit : MonoBehaviour
{
	[Header("MAIN TARGET")]
	public Transform CurrentTarget;

	[Header("Weapon Stuff")]
	private WeaponScript Weapon;

	public GameObject TrackBullet;

	public GameObject FlatBullet;

	public GameObject Canvas;

	public GameObject Indiactor;

	[Header("Reticle Stuff")]
	public Camera Cam;

	public List<GameObject> Targets;

	public List<Transform> Reticles;

	public Transform ClosestReticle;

	public ScreenTarget ClosestTarget;

	private float ActiveRadius = 0.15f;

	private float TargetDistance;

	private bool hasSight;

	private bool Locked;

	[Header("Charge Stuff")]
	public bool KeepTime;

	public float ChargeTime = 1f;

	[Header("Charge Stuff")]
	private ExploitTarget[] Enemies;

	private void Awake()
	{
		Weapon = GetComponent<WeaponScript>();
		Enemies = Object.FindObjectsOfType<ExploitTarget>();
		ExploitTarget[] enemies = Enemies;
		for (int i = 0; i < enemies.Length; i++)
		{
			enemies[i].LookAgain();
		}
	}

	private void FixedUpdate()
	{
		UpdateBullets();
		ScreenTarget[] screenTargets = TrackAllTargets(Targets);
		screenTargets = GetValidTargets(screenTargets);
		for (int i = 0; i < Reticles.Count; i++)
		{
			if (i < screenTargets.Length)
			{
				Reticles[i].position = screenTargets[i].screenPosition;
				Reticles[i].gameObject.SetActive(value: true);
			}
			else
			{
				Reticles[i].gameObject.SetActive(value: false);
				Reticles[i].position = Vector3.zero;
			}
		}
		ClosestTarget = GetClosestTarget(screenTargets);
		if (ClosestTarget == null)
		{
			new Vector2(Screen.width / 2, Screen.height / 2);
		}
		else
		{
			_ = ClosestTarget.screenPosition;
		}
		if (ClosestTarget != null)
		{
			FindCurrentTarget();
		}
	}

	private void UpdateBullets()
	{
		if (ClosestTarget == null)
		{
			Weapon.PrimaryBullet = FlatBullet;
			hasSight = false;
			ClosestReticle.GetComponent<Image>().color = new Color32(0, byte.MaxValue, 0, byte.MaxValue);
			KeepTime = false;
			Locked = false;
			Indiactor.SetActive(value: false);
			ChargeTime = 0.5f;
		}
		else
		{
			hasSight = true;
			KeepTime = true;
		}
		if (KeepTime)
		{
			ChargeTime -= Time.deltaTime;
			if (ChargeTime <= 0f && !Locked)
			{
				Indiactor.SetActive(value: true);
				Weapon.PrimaryBullet = TrackBullet;
				ClosestReticle.GetComponent<Image>().color = new Color32(byte.MaxValue, byte.MaxValue, byte.MaxValue, byte.MaxValue);
				Locked = true;
			}
		}
	}

	private ScreenTarget[] TrackAllTargets(List<GameObject> targets)
	{
		ScreenTarget[] array = new ScreenTarget[targets.Count];
		for (int i = 0; i < targets.Count; i++)
		{
			array[i] = new ScreenTarget();
			array[i].targetObject = targets[i];
			array[i].screenPosition = Cam.WorldToScreenPoint(targets[i].transform.position);
		}
		return array;
	}

	private ScreenTarget[] GetValidTargets(ScreenTarget[] screenTargets)
	{
		List<ScreenTarget> list = new List<ScreenTarget>();
		float num = 0f;
		foreach (ScreenTarget screenTarget in screenTargets)
		{
			if ((screenTarget.DistanceFromCenter = Vector2.Distance(screenTarget.screenPosition, new Vector2(Cam.pixelWidth / 2, Cam.pixelHeight / 2))) < ActiveRadius * (float)Cam.pixelWidth)
			{
				list.Add(screenTarget);
			}
		}
		return list.ToArray();
	}

	public ScreenTarget GetClosestTarget(ScreenTarget[] screenTargets)
	{
		ScreenTarget result = null;
		float num = float.MaxValue;
		foreach (ScreenTarget screenTarget in screenTargets)
		{
			if (screenTarget.DistanceFromCenter < num)
			{
				num = screenTarget.DistanceFromCenter;
				result = screenTarget;
			}
		}
		return result;
	}

	public void FindCurrentTarget()
	{
		if (ClosestTarget != null)
		{
			CurrentTarget = ClosestTarget.targetObject.transform;
		}
	}
}
